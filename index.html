<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Video Call</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .video-container { aspect-ratio: 16/9; }
    .pulse-connecting { animation: pulse 2s infinite; }
    @keyframes pulse { 0%{opacity:1;} 50%{opacity:.5;} 100%{opacity:1;} }
    .status-connected { background-color:#10B981 !important; }
    .status-connecting { background-color:#F59E0B !important; }
    .status-disconnected { background-color:#EF4444 !important; }
  </style>
</head>
<body class="bg-gray-900 text-white">
  <!-- Header -->
  <header class="bg-gray-800 p-4 shadow-md flex justify-between">
    <h1 class="text-2xl font-bold flex items-center">
      <i class="fas fa-users mr-2 text-blue-400"></i> Family Video Call
    </h1>
    <div id="connectionStatus" class="flex items-center">
      <span class="h-3 w-3 rounded-full status-disconnected mr-2"></span>
      <span>Disconnected</span>
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto p-4 flex flex-col lg:flex-row gap-6">
    <!-- Video -->
    <div class="lg:w-3/4">
      <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-4">
        <div class="flex flex-col md:flex-row gap-4">
          <input id="roomName" placeholder="Room name"
                 class="flex-1 p-3 bg-gray-700 border rounded-lg">
          <input id="displayName" placeholder="Your name" value="User"
                 class="flex-1 p-3 bg-gray-700 border rounded-lg">
          <button id="joinBtn" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg">
            <i class="fas fa-video mr-2"></i> Join
          </button>
        </div>
        <div class="mt-4 flex gap-2 flex-wrap">
          <button id="toggleVideoBtn" class="bg-gray-700 p-2 rounded-lg" disabled>
            <i class="fas fa-video mr-1"></i> Video
          </button>
          <button id="toggleAudioBtn" class="bg-gray-700 p-2 rounded-lg" disabled>
            <i class="fas fa-microphone mr-1"></i> Audio
          </button>
          <button id="leaveBtn" class="bg-red-600 p-2 rounded-lg" disabled>
            <i class="fas fa-phone-slash mr-1"></i> Leave
          </button>
        </div>
      </div>
      <div id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="text-center text-gray-500 py-8 col-span-2">
          <i class="fas fa-video text-4xl mb-4"></i>
          <p>Join a room to start video calling</p>
        </div>
      </div>
    </div>

    <!-- Chat -->
    <div class="lg:w-1/4 bg-gray-800 rounded-lg shadow-lg flex flex-col h-[600px]">
      <div class="p-4 border-b border-gray-700 flex items-center">
        <i class="fas fa-comments mr-2 text-blue-400"></i><h2>Chat</h2>
      </div>
      <div id="chatMessages" class="flex-1 p-4 overflow-y-auto">
        <div class="text-center text-gray-400 py-4">No messages yet.</div>
      </div>
      <div class="p-4 border-t border-gray-700 flex">
        <input id="chatInput" placeholder="Type..." disabled
               class="flex-1 p-3 bg-gray-700 border rounded-l-lg">
        <button id="sendBtn" disabled
                class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-r-lg">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </main>

<script>
const SOCKET_SERVER_URL = location.hostname==='localhost' ? 'http://localhost:3000' : 'https://video-call-l2ij.onrender.com';
const socket = io(SOCKET_SERVER_URL, { transports: ['websocket','polling'] });

const videoGrid=document.getElementById('videoGrid');
const roomNameInput=document.getElementById('roomName');
const displayNameInput=document.getElementById('displayName');
const joinBtn=document.getElementById('joinBtn');
const toggleVideoBtn=document.getElementById('toggleVideoBtn');
const toggleAudioBtn=document.getElementById('toggleAudioBtn');
const leaveBtn=document.getElementById('leaveBtn');
const chatMessages=document.getElementById('chatMessages');
const chatInput=document.getElementById('chatInput');
const sendBtn=document.getElementById('sendBtn');
const connectionStatus=document.getElementById('connectionStatus');

let myStream=null,isVideoOn=true,isAudioOn=true,currentRoom=null,myDisplayName='User';
const peers={},userDisplayNames={};

function updateConnectionStatus(status){
  const indicator=connectionStatus.querySelector('.h-3');
  const text=connectionStatus.querySelector('span:last-child');
  indicator.className='h-3 w-3 rounded-full mr-2 '+
    (status==='connected'?'status-connected':status==='connecting'?'status-connecting pulse-connecting':'status-disconnected');
  text.textContent=status.charAt(0).toUpperCase()+status.slice(1);
}

async function initMedia(){
  try{
    myStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    myDisplayName=displayNameInput.value.trim()||`User${Math.random().toString(36).substr(2,5)}`;
    userDisplayNames[socket.id]=myDisplayName;
    addVideoStream(myStream,myDisplayName,'local',socket.id);
    [toggleVideoBtn,toggleAudioBtn,leaveBtn,chatInput,sendBtn].forEach(b=>b.disabled=false);
    toggleVideoBtn.classList.add('bg-green-600');toggleAudioBtn.classList.add('bg-green-600');
    return true;
  }catch(err){console.error('Media error',err);alert('No camera/microphone.');return false;}
}

function addVideoStream(stream,userName,type,userId){
  const idKey=type==='local'?'local':userId;
  removeVideoStream(idKey);
  const c=document.createElement('div');c.className='relative bg-black rounded-lg overflow-hidden video-container';c.id=`video-${idKey}`;
  const v=document.createElement('video');
  v.srcObject=stream;v.autoplay=true;v.playsInline=true;v.muted=(type==='local');
  v.className='w-full h-full object-cover';
  
  // Improved video event handling
  v.onloadedmetadata=()=>{
    console.log('‚úÖ Video metadata loaded for', userName);
    v.play().catch(err=>console.error('Play failed',err));
  };
  
  v.onplay=()=>{
    console.log('üé¨ Video started playing for', userName);
  };
  
  v.onresize=()=>{
    console.log('üìê Video resized for', userName);
  };
  
  const l=document.createElement('div');l.className='absolute bottom-2 left-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-sm';
  l.textContent=userName+(type==='local'?' (You)':'');
  c.appendChild(v);c.appendChild(l);videoGrid.appendChild(c);
  const ph=videoGrid.querySelector('.text-center');if(ph)ph.remove();
  
  console.log('‚úÖ Added video stream for', userName);
}

function removeVideoStream(idKey){const el=document.getElementById(`video-${idKey}`);if(el)el.remove();}

// üîß Improved PeerConnection with better STUN servers
async function createPeerConnection(userId){
  console.log('üîó Creating peer connection for', userId);
  
  const p=new RTCPeerConnection({
    iceServers:[
      { urls:'stun:stun.l.google.com:19302' },
      { urls:'stun:stun1.l.google.com:19302' },
      { urls:'stun:stun2.l.google.com:19302' },
      { urls:'stun:stun3.l.google.com:19302' },
      { urls:'stun:stun4.l.google.com:19302' },
      // Free TURN servers for fallback
      {
        urls: 'turn:numb.viagenie.ca',
        username: 'webrtc@live.com',
        credential: 'muazkh'
      }
    ],
    iceCandidatePoolSize: 10
  });
  
  // Add local tracks
  if(myStream){ 
    myStream.getTracks().forEach(track=>{
      console.log('‚ûï Adding track:', track.kind);
      p.addTrack(track,myStream);
    });
  }

  // Improved track handling
  p.ontrack=(event)=>{
    console.log('üìπ Remote track received from', userId, event.streams);
    console.log('Tracks:', event.tracks);
    
    if(event.streams && event.streams[0]){
      const remoteStream=event.streams[0];
      const videoTracks=remoteStream.getVideoTracks();
      const audioTracks=remoteStream.getAudioTracks();
      
      console.log('üé• Video tracks:', videoTracks.length);
      console.log('üé§ Audio tracks:', audioTracks.length);
      
      if(videoTracks.length>0){
        videoTracks[0].onunmute=()=>{
          console.log('üé¨ Video track unmuted for', userId);
        };
        
        videoTracks[0].onmute=()=>{
          console.log('üîá Video track muted for', userId);
        };
      }
      
      const displayName=userDisplayNames[userId]||`User ${userId.substring(0,6)}`;
      addVideoStream(remoteStream,displayName,'remote',userId);
    }
  };

  p.oniceconnectionstatechange=()=>{
    console.log(`‚ùÑÔ∏è ICE state for ${userId}:`, p.iceConnectionState);
    if(p.iceConnectionState==='connected'||p.iceConnectionState==='completed'){
      console.log('‚úÖ Peer connection established with', userId);
    }
  };

  p.onconnectionstatechange=()=>{
    console.log(`üîó Connection state for ${userId}:`, p.connectionState);
  };

  p.onicecandidate=(event)=>{
    if(event.candidate&&currentRoom){
      console.log('‚ùÑÔ∏è Sending ICE candidate to', userId);
      socket.emit('ice-candidate',{candidate:event.candidate,to:userId,room:currentRoom});
    }
  };

  return p;
}

joinBtn.addEventListener('click',async()=>{
  const room=roomNameInput.value.trim().toLowerCase();if(!room){alert('Enter room name');return;}
  if(!await initMedia())return;currentRoom=room;updateConnectionStatus('connecting');
  socket.emit('join-room',room,myDisplayName);
  joinBtn.disabled=true;roomNameInput.disabled=true;displayNameInput.disabled=true;
});

// Leave Call
leaveBtn.addEventListener('click',()=>{
  if(currentRoom)socket.emit('leave-room',currentRoom);
  Object.values(peers).forEach(p=>p.close());
  for(const id in peers)delete peers[id];
  if(myStream)myStream.getTracks().forEach(t=>t.stop());
  videoGrid.innerHTML='<div class="text-center text-gray-500 py-8 col-span-2"><i class="fas fa-video text-4xl mb-4"></i><p>Join a room to start video calling</p></div>';
  chatMessages.innerHTML='<div class="text-center text-gray-400 py-4">No messages yet.</div>';
  [toggleVideoBtn,toggleAudioBtn,leaveBtn,chatInput,sendBtn].forEach(b=>b.disabled=true);
  joinBtn.disabled=false;roomNameInput.disabled=false;displayNameInput.disabled=false;
  updateConnectionStatus('disconnected');
  currentRoom=null;
});

// Socket events
socket.on('room-joined',async(users)=>{
  updateConnectionStatus('connected');
  console.log('üë• Users in room:', users);
  
  for(const u of users){
    if(u.id!==socket.id){
      userDisplayNames[u.id]=u.displayName;
      await createAndSendOffer(u.id);
    }
  }
});

socket.on('user-connected',async(id,name)=>{
  console.log('üëã User joined', id, name);
  userDisplayNames[id]=name;
  await createAndSendOffer(id);
});

socket.on('offer',async({offer,from})=>{
  console.log('üì® Got offer from', from);
  try{
    const p=await createPeerConnection(from);
    peers[from]=p;
    await p.setRemoteDescription(new RTCSessionDescription(offer));
    const answer=await p.createAnswer();
    await p.setLocalDescription(answer);
    socket.emit('answer',{answer:answer,to:from,room:currentRoom});
    console.log('üì§ Sent answer to', from);
  }catch(error){
    console.error('Error handling offer:', error);
  }
});

socket.on('answer',async({answer,from})=>{
  console.log('üì® Got answer from', from);
  try{
    if(peers[from]){
      await peers[from].setRemoteDescription(new RTCSessionDescription(answer));
      console.log('‚úÖ Set remote description for', from);
    }
  }catch(error){
    console.error('Error handling answer:', error);
  }
});

socket.on('ice-candidate',async({candidate,from})=>{
  console.log('‚ùÑÔ∏è Got ICE candidate from', from);
  if(peers[from]){
    try{
      await peers[from].addIceCandidate(new RTCIceCandidate(candidate));
      console.log('‚úÖ Added ICE candidate for', from);
    }catch(e){
      console.error('Error adding ICE candidate:', e);
    }
  }
});

socket.on('user-disconnected',(id)=>{
  console.log('‚ùå User left', id);
  if(peers[id]){
    peers[id].close();
    delete peers[id];
  }
  removeVideoStream(id);
  delete userDisplayNames[id];
});

// Improved offer creation
async function createAndSendOffer(id){
  try{
    console.log('üì§ Creating offer for', id);
    const p=await createPeerConnection(id);
    peers[id]=p;
    
    const offer=await p.createOffer({
      offerToReceiveAudio: true,
      offerToReceiveVideo: true
    });
    
    await p.setLocalDescription(offer);
    
    socket.emit('offer',{
      offer: offer,
      to: id,
      room: currentRoom
    });
    
    console.log('üì§ Sent offer to', id);
  }catch(error){
    console.error('Error creating offer:', error);
  }
}

// Chat
function sendMessage(){
  const msg=chatInput.value.trim();if(!msg||!currentRoom)return;
  addChatMessage(myDisplayName,msg,'outgoing');
  socket.emit('chat-message',{room:currentRoom,message:msg,userName:myDisplayName});
  chatInput.value='';
}

function addChatMessage(user,message,type='incoming'){
  const m=document.createElement('div');m.className=`mb-3 ${type==='outgoing'?'text-right':''}`;
  m.innerHTML=`<div class="inline-block p-3 rounded-lg max-w-xs ${type==='outgoing'?'bg-blue-600 text-white':'bg-gray-700 text-white'}">
    <div class="text-xs font-semibold mb-1 ${type==='outgoing'?'text-blue-200':'text-gray-400'}">${user}</div>
    <div class="text-sm">${message}</div></div>`;
  const ph=chatMessages.querySelector('.text-center');if(ph)ph.remove();
  chatMessages.appendChild(m);chatMessages.scrollTop=chatMessages.scrollHeight;
}

sendBtn.addEventListener('click',sendMessage);
chatInput.addEventListener('keypress',(e)=>{if(e.key==='Enter')sendMessage();});

socket.on('chat-message',({message,userId,userName})=>{
  addChatMessage(userName||`User ${userId.substring(0,6)}`,message,'incoming');
});

// Toggle video/audio
toggleVideoBtn.addEventListener('click',()=>{
  const t=myStream.getVideoTracks()[0];
  if(!t)return;
  isVideoOn=!isVideoOn;
  t.enabled=isVideoOn;
  toggleVideoBtn.classList.toggle('bg-green-600',isVideoOn);
  toggleVideoBtn.classList.toggle('bg-gray-700',!isVideoOn);
  
  // Notify others
  if(currentRoom){
    socket.emit('user-media-update',{
      room: currentRoom,
      video: isVideoOn,
      audio: isAudioOn
    });
  }
});

toggleAudioBtn.addEventListener('click',()=>{
  const t=myStream.getAudioTracks()[0];
  if(!t)return;
  isAudioOn=!isAudioOn;
  t.enabled=isAudioOn;
  toggleAudioBtn.classList.toggle('bg-green-600',isAudioOn);
  toggleAudioBtn.classList.toggle('bg-gray-700',!isAudioOn);
  
  // Notify others
  if(currentRoom){
    socket.emit('user-media-update',{
      room: currentRoom,
      video: isVideoOn,
      audio: isAudioOn
    });
  }
});

// Debug: Log peer states periodically
setInterval(()=>{
  if(Object.keys(peers).length>0){
    console.log('--- Active Peers Status ---');
    Object.entries(peers).forEach(([id,peer])=>{
      console.log(`Peer ${id}:`,{
        connectionState:peer.connectionState,
        iceConnectionState:peer.iceConnectionState
      });
    });
  }
},10000);
</script>
</body>
</html>
