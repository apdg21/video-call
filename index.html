<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Video Call</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .video-container { aspect-ratio: 16/9; }
    .pulse-connecting { animation: pulse 2s infinite; }
    @keyframes pulse { 0%{opacity:1;} 50%{opacity:.5;} 100%{opacity:1;} }
    .status-connected { background-color:#10B981 !important; }
    .status-connecting { background-color:#F59E0B !important; }
    .status-disconnected { background-color:#EF4444 !important; }
  </style>
</head>
<body class="bg-gray-900 text-white">
  <!-- Header -->
  <header class="bg-gray-800 p-4 shadow-md flex justify-between">
    <h1 class="text-2xl font-bold flex items-center">
      <i class="fas fa-users mr-2 text-blue-400"></i> Family Video Call
    </h1>
    <div id="connectionStatus" class="flex items-center">
      <span class="h-3 w-3 rounded-full status-disconnected mr-2"></span>
      <span>Disconnected</span>
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto p-4 flex flex-col lg:flex-row gap-6">
    <!-- Video -->
    <div class="lg:w-3/4">
      <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-4">
        <div class="flex flex-col md:flex-row gap-4">
          <input id="roomName" placeholder="Room name"
                 class="flex-1 p-3 bg-gray-700 border rounded-lg">
          <input id="displayName" placeholder="Your name" value="User"
                 class="flex-1 p-3 bg-gray-700 border rounded-lg">
          <button id="joinBtn" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg">
            <i class="fas fa-video mr-2"></i> Join
          </button>
        </div>
        <div class="mt-4 flex gap-2 flex-wrap">
          <button id="toggleVideoBtn" class="bg-gray-700 p-2 rounded-lg" disabled>
            <i class="fas fa-video mr-1"></i> Video
          </button>
          <button id="toggleAudioBtn" class="bg-gray-700 p-2 rounded-lg" disabled>
            <i class="fas fa-microphone mr-1"></i> Audio
          </button>
          <button id="leaveBtn" class="bg-red-600 p-2 rounded-lg" disabled>
            <i class="fas fa-phone-slash mr-1"></i> Leave
          </button>
        </div>
      </div>
      <div id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="text-center text-gray-500 py-8 col-span-2">
          <i class="fas fa-video text-4xl mb-4"></i>
          <p>Join a room to start video calling</p>
        </div>
      </div>
    </div>

    <!-- Chat -->
    <div class="lg:w-1/4 bg-gray-800 rounded-lg shadow-lg flex flex-col h-[600px]">
      <div class="p-4 border-b border-gray-700 flex items-center">
        <i class="fas fa-comments mr-2 text-blue-400"></i><h2>Chat</h2>
      </div>
      <div id="chatMessages" class="flex-1 p-4 overflow-y-auto">
        <div class="text-center text-gray-400 py-4">No messages yet.</div>
      </div>
      <div class="p-4 border-t border-gray-700 flex">
        <input id="chatInput" placeholder="Type..." disabled
               class="flex-1 p-3 bg-gray-700 border rounded-l-lg">
        <button id="sendBtn" disabled
                class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-r-lg">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </main>

<script>
const SOCKET_SERVER_URL = location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://video-call-l2ij.onrender.com';
const socket = io(SOCKET_SERVER_URL, { transports: ['websocket', 'polling'] });

const videoGrid = document.getElementById('videoGrid');
const roomNameInput = document.getElementById('roomName');
const displayNameInput = document.getElementById('displayName');
const joinBtn = document.getElementById('joinBtn');
const toggleVideoBtn = document.getElementById('toggleVideoBtn');
const toggleAudioBtn = document.getElementById('toggleAudioBtn');
const leaveBtn = document.getElementById('leaveBtn');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const connectionStatus = document.getElementById('connectionStatus');

let myStream = null, isVideoOn = true, isAudioOn = true, currentRoom = null, myDisplayName = 'User';
const peers = {}, userDisplayNames = {};

function updateConnectionStatus(status) {
  const indicator = connectionStatus.querySelector('.h-3');
  const text = connectionStatus.querySelector('span:last-child');
  indicator.className = 'h-3 w-3 rounded-full mr-2 ' +
    (status === 'connected' ? 'status-connected' : status === 'connecting' ? 'status-connecting pulse-connecting' : 'status-disconnected');
  text.textContent = status.charAt(0).toUpperCase() + status.slice(1);
}

async function initMedia() {
  try {
    myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    myDisplayName = displayNameInput.value.trim() || `User${Math.random().toString(36).substr(2, 5)}`;
    userDisplayNames[socket.id] = myDisplayName;
    addVideoStream(myStream, myDisplayName, 'local', socket.id);
    [toggleVideoBtn, toggleAudioBtn, leaveBtn, chatInput, sendBtn].forEach(b => b.disabled = false);
    toggleVideoBtn.classList.add('bg-green-600');
    toggleAudioBtn.classList.add('bg-green-600');
    return true;
  } catch (err) {
    console.error('Media error:', err.name, err.message);
    alert(`Failed to access camera/microphone: ${err.message}. Please check permissions or device availability.`);
    return false;
  }
}

function addVideoStream(stream, userName, type, userId) {
  const idKey = type === 'local' ? 'local' : userId;
  removeVideoStream(idKey);
  const c = document.createElement('div');
  c.className = 'relative bg-black rounded-lg overflow-hidden video-container';
  c.id = `video-${idKey}`;
  const v = document.createElement('video');
  v.srcObject = stream;
  v.autoplay = true;
  v.playsInline = true;
  v.muted = (type === 'local');
  v.className = 'w-full h-full object-cover';
  v.onloadedmetadata = () => v.play().catch(err => console.error('Play failed', err));
  const l = document.createElement('div');
  l.className = 'absolute bottom-2 left-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-sm';
  l.textContent = userName + (type === 'local' ? ' (You)' : '');
  c.appendChild(v);
  c.appendChild(l);
  videoGrid.appendChild(c);
  const ph = videoGrid.querySelector('.text-center');
  if (ph) ph.remove();
}

function removeVideoStream(idKey) {
  const el = document.getElementById(`video-${idKey}`);
  if (el) el.remove();
}

async function createPeerConnection(userId) {
  const p = new RTCPeerConnection({
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' }
    ]
  });
  if (myStream) {
    myStream.getTracks().forEach(t => {
      console.log('Adding track:', t.kind, t.enabled);
      p.addTrack(t, myStream);
    });
  }
  p.ontrack = (e) => {
    console.log('ðŸ“¹ Remote track from', userId, e.streams[0].getTracks());
    const n = userDisplayNames[userId] || `User ${userId.substring(0, 6)}`;
    addVideoStream(e.streams[0], n, 'remote', userId);
  };
  p.onicecandidate = (e) => {
    if (e.candidate && currentRoom) {
      socket.emit('ice-candidate', { candidate: e.candidate, to: userId, room: currentRoom });
    }
  };
  p.onconnectionstatechange = () => console.log(`Peer ${userId} state`, p.connectionState);
  return p;
}

joinBtn.addEventListener('click', async () => {
  const room = roomNameInput.value.trim().toLowerCase();
  if (!room) { alert('Enter room name'); return; }
  if (!await initMedia()) return;
  currentRoom = room;
  updateConnectionStatus('connecting');
  socket.emit('join-room', room, myDisplayName);
  joinBtn.disabled = true;
  roomNameInput.disabled = true;
  displayNameInput.disabled = true;
});

leaveBtn.addEventListener('click', () => {
  if (currentRoom) socket.emit('leave-room', currentRoom);
  Object.values(peers).forEach(p => p.close());
  for (const id in peers) delete peers[id];
  if (myStream) myStream.getTracks().forEach(t => t.stop());
  videoGrid.innerHTML = '<div class="text-center text-gray-500 py-8 col-span-2"><i class="fas fa-video text-4xl mb-4"></i><p>Join a room to start video calling</p></div>';
  chatMessages.innerHTML = '<div class="text-center text-gray-400 py-4">No messages yet.</div>';
  [toggleVideoBtn, toggleAudioBtn, leaveBtn, chatInput, sendBtn].forEach(b => b.disabled = true);
  joinBtn.disabled = false;
  roomNameInput.disabled = false;
  displayNameInput.disabled = false;
  updateConnectionStatus('disconnected');
  currentRoom = null;
});

function sendMessage() {
  const msg = chatInput.value.trim();
  if (!msg || !currentRoom) return;
  addChatMessage(myDisplayName, msg, 'outgoing');
  socket.emit('chat-message', { room: currentRoom, message: msg, userName: myDisplayName });
  chatInput.value = '';
}

function addChatMessage(user, message, type = 'incoming') {
  const m = document.createElement('div');
  m.className = `mb-3 ${type === 'outgoing' ? 'text-right' : ''}`;
  m.innerHTML = `<div class="inline-block p-3 rounded-lg max-w-xs ${type === 'outgoing' ? 'bg-blue-600 text-white' : 'bg-gray-700 text-white'}">
    <div class="text-xs font-semibold mb-1 ${type === 'outgoing' ? 'text-blue-200' : 'text-gray-400'}">${user}</div>
    <div class="text-sm">${message}</div></div>`;
  const ph = chatMessages.querySelector('.text-center');
  if (ph) ph.remove();
  chatMessages.appendChild(m);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

sendBtn.addEventListener('click', sendMessage);
chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

socket.on('room-joined', async (users) => {
  updateConnectionStatus('connected');
  for (const u of users) {
    userDisplayNames[u.id] = u.displayName;
    if (u.id !== socket.id) await createAndSendOffer(u.id);
  }
});

socket.on('user-connected', async (id, name) => {
  console.log('User joined', id);
  userDisplayNames[id] = name;
  await createAndSendOffer(id);
});

socket.on('offer', async ({ offer, from }) => {
  console.log('ðŸ“¨ Received offer from', from, offer);
  const p = await createPeerConnection(from);
  peers[from] = p;
  await p.setRemoteDescription(new RTCSessionDescription(offer));
  const a = await p.createAnswer();
  await p.setLocalDescription(a);
  socket.emit('answer', { answer: a, to: from, room: currentRoom });
});

socket.on('answer', async ({ answer, from }) => {
  console.log('ðŸ“¨ Received answer from', from, answer);
  if (peers[from]) await peers[from].setRemoteDescription(new RTCSessionDescription(answer));
});

socket.on('ice-candidate', async ({ candidate, from }) => {
  console.log('ðŸ“¨ Received ICE candidate from', from, candidate);
  if (peers[from]) {
    try {
      await peers[from].addIceCandidate(new RTCIceCandidate(candidate));
    } catch (e) {
      console.error('Error adding ICE candidate:', e);
    }
  }
});

socket.on('user-disconnected', (id) => {
  console.log('âŒ User left', id);
  if (peers[id]) {
    peers[id].close();
    delete peers[id];
  }
  removeVideoStream(id);
  delete userDisplayNames[id];
});

socket.on('chat-message', ({ message, userId, userName }) => {
  addChatMessage(userName || `User ${userId.substring(0, 6)}`, message, 'incoming');
});

socket.on('user-media-update', ({ userId, video, audio }) => {
  const videoElement = document.getElementById(`video-${userId}`);
  if (videoElement) {
    const video = videoElement.querySelector('video');
    videoElement.style.opacity = video ? '1' : '0.5';
    if (!video) {
      video.srcObject = null;
      video.poster = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50%" y="50%" alignment-baseline="middle" text-anchor="middle" fill="white">Video Off</text></svg>';
    }
  }
});

async function createAndSendOffer(id) {
  if (peers[id]) return;
  const p = await createPeerConnection(id);
  peers[id] = p;
  const o = await p.createOffer();
  await p.setLocalDescription(o);
  socket.emit('offer', { offer: o, to: id, room: currentRoom });
}

toggleVideoBtn.addEventListener('click', () => {
  const t = myStream.getVideoTracks()[0];
  if (!t) return;
  isVideoOn = !isVideoOn;
  t.enabled = isVideoOn;
  toggleVideoBtn.classList.toggle('bg-green-600', isVideoOn);
  toggleVideoBtn.classList.toggle('bg-gray-700', !isVideoOn);
  socket.emit('user-media-update', { room: currentRoom, video: isVideoOn, audio: isAudioOn });
});

toggleAudioBtn.addEventListener('click', () => {
  const t = myStream.getAudioTracks()[0];
  if (!t) return;
  isAudioOn = !isAudioOn;
  t.enabled = isAudioOn;
  toggleAudioBtn.classList.toggle('bg-green-600', isAudioOn);
  toggleAudioBtn.classList.toggle('bg-gray-700', !isAudioOn);
  socket.emit('user-media-update', { room: currentRoom, video: isVideoOn, audio: isAudioOn });
});
</script>
</body>
</html>
